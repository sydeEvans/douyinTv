## 当前逻辑与定位
- 播放栈：`GSYVideoPlayer + IjkMediaPlayer`，Surface 渲染、硬解优先（app/src/main/java/com/example/douyintv/MainActivity.kt:76-105）。
- 数据与网络：`Retrofit+OkHttp` 拉取 Douyin Feed，头部与令牌硬编码（app/src/main/java/com/example/douyintv/data/NetworkClient.kt:13-27；app/src/main/java/com/example/douyintv/data/DouyinApi.kt:8-62；scripts/get.js:1-17）。
- 策略与容错：编解码能力筛选、加载/缓冲/进度超时看门狗、候选回退与切源（app/src/main/java/com/example/douyintv/MainActivity.kt:286-322, 187-245, 647-701）。

## 优化目标（保持 GSY+Ijk）
- 首帧更快：降低 Ijk 分析与建连开销，减少切条首帧等待。
- 少卡顿：更智能的降级与重试，避免过度跳过。
- 更稳容错：事件驱动的监控替代纯轮询，阈值自适应。
- 易维护：令牌与头部治理，避免硬编码与过期。
- 可观测：关键指标与日志完善，支持调参。

## 实施方案
### 1. Ijk 播放器参数调优（初始化处）
- 增加 Ijk 选项（MainActivity.kt:87-105）：
  - `analyzeduration = 1`、`probesize = 10240`：缩短流分析时间，加快起播。
  - `packet-buffering = 0`：起播更激进，结合看门狗控制卡顿风险。
  - `framedrop = 1`：性能紧张时丢帧保流畅。
  - `enable-accurate-seek = 1`：Seek 更精准（配合长按快进/快退）。
  - `reconnect = 1`：弱网自动重连一次，减少瞬断失败。
- 保持硬解与分辨率处理：`mediacodec/*`、`skip_loop_filter` 维持现有设置。

### 2. 事件驱动的看门狗与阈值自适应
- 接入 `GSYVideoView` 全量回调（MainActivity 增强）：基于 `onPrepared/OnInfo(首帧)/onError` 精确控制加载/缓冲/进度监控的启停，避免误判。
- 阈值自适应：参考设备性能（CPU/内存）与最近网络耗时（OkHttp 连接/读取时间）调整 `8s/12s/15s` 为区间范围（例如弱网上限 +30%）。
- 重试节制：每个候选仅尝试一次同编码降档与一次跨编码，随后才切 URL，最终才跳过。

### 3. 预热与缓存（保持 GSY+Ijk）
- 启用 GSY HTTP 代理缓存：对 MP4 源开启 `cacheWithPlay(true)` 并指定缓存目录，降低回看与切源卡顿。
- 预加载下一条：改造 `warmUpNext`（MainActivity.kt:624-645），用短 `GET Range: bytes=0-262143` 代替 `HEAD`，并通过代理缓存填充 256KB 预热，提升首帧。
- 预热节流：限制同时预热 1 条、失败冷却 30s，避免对源与网络造成压力。

### 4. 候选选择策略优化
- 在现有 HEVC/AVC + 分辨率/码率排序基础上（MainActivity.kt:296-301），加入网络估计下限（如 ≤8Mbps 优先），减少高码率误选导致初始卡缓。
- URL 列表顺序优化：优先 `douyin.com` 源，其次镜像；失败时轮转（MainActivity.kt:279-283, 687-701）。

### 5. 网络与令牌治理
- 引入 `TokenProvider` 接口：`NetworkClient` 通过提供者获取 `msToken/a_bogus/UIFID/Cookie`，支持更新与持久化（替代硬编码）。
- 失败分流：鉴权失败（4xx+签名提示）与源不可用（5xx/超时）区分处理：前者触发令牌刷新，后者走候选/URL 回退或跳过。
- OkHttp 调参：连接超时/读超时分开设置，连接池与 DNS 优化，减少建连与握手耗时。

### 6. 指标与日志
- 指标：首帧耗时、重缓次数/时长、候选回退层级、切源次数/跳过原因，按视频记录到本地日志文件。
- 日志开关：Debug 全量、Release 精简；支持导出以便现场调参。
- 开发面板：在开发开关下暴露阈值与策略参数，快速试错。

## 验证与回归
- 弱网与不稳源：限速 2-4Mbps、随机 404/超时，验证首帧与卡顿指标。
- 切条压力测试：连续切换 20 次、长按快进/快退、暂停/恢复，观察资源释放与稳定性（MainActivity.kt:539-566）。
- 指标对比：与当前版本对比首帧耗时与重缓率、跳过频次，确认显著改善。

## 风险与回滚
- 代理缓存风险：源不支持 Range 时自动回退到直连；缓存开关可随时关闭。
- 阈值自适应异常：计算失败时回落到固定阈值（现有 8s/12s/15s）。
- 令牌治理：不在代码中持久化真实令牌，使用占位与注入方式，避免泄露。

## 交付物
- 增强的 Ijk 参数与事件驱动看门狗、候选策略优化、预热与缓存接入。
- `NetworkClient` 令牌治理与失败分流、OkHttp 调参。
- 指标与日志输出、调参入口。

请确认以上“仅在 GSY+Ijk 基础上优化”的方案，我将据此分阶段实施并提供数据对比。